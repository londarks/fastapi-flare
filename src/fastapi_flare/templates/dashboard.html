<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>__FLARE_TITLE__</title>
  <!-- Font Awesome: only external dependency. Degrades gracefully if offline. -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:         #080808;
      --bg-card:    #101010;
      --bg-row:     #131313;
      --bg-hover:   #1a1a1a;
      --border:     #1f1f1f;
      --border-dim: #2a2a2a;
      --red:        #dc2626;
      --red-light:  #ef4444;
      --red-glow:   rgba(220, 38, 38, 0.18);
      --red-dim:    rgba(220, 38, 38, 0.08);
      --amber:      #f59e0b;
      --amber-dim:  rgba(245, 158, 11, 0.10);
      --white:      #f9f9f9;
      --gray:       #6b7280;
      --gray-light: #9ca3af;
      --mono:       'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    }

    html, body { height: 100%; background: var(--bg); color: var(--white); font-family: 'Inter', system-ui, sans-serif; font-size: 14px; }

    /* ── SCROLLBAR ── */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--red); }

    /* ── HEADER ── */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      height: 56px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 16px; padding: 0 24px;
    }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 15px; letter-spacing: -.3px; }
    .logo i { color: var(--red); font-size: 18px; }
    .logo span { color: var(--white); }
    .logo .badge { font-size: 10px; font-weight: 600; background: var(--red-dim); border: 1px solid var(--red); color: var(--red-light); padding: 2px 7px; border-radius: 99px; letter-spacing: .5px; text-transform: uppercase; }
    .header-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
    .refresh-toggle { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--gray-light); cursor: pointer; user-select: none; }
    .toggle-switch { position: relative; width: 36px; height: 20px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: #222; border-radius: 99px; transition: .2s; cursor: pointer; }
    .toggle-slider::before { content: ''; position: absolute; left: 3px; top: 3px; width: 14px; height: 14px; background: var(--gray); border-radius: 50%; transition: .2s; }
    .toggle-switch input:checked + .toggle-slider { background: var(--red-glow); border: 1px solid var(--red); }
    .toggle-switch input:checked + .toggle-slider::before { background: var(--red-light); transform: translateX(16px); }

    /* ── MAIN ── */
    main { margin-top: 56px; padding: 24px; max-width: 1600px; margin-left: auto; margin-right: auto; }

    /* ── STATS ── */
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    .stat-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
      padding: 16px 20px; display: flex; flex-direction: column; gap: 4px;
      transition: border-color .2s;
    }
    .stat-card:hover { border-color: var(--border-dim); }
    .stat-card.red { border-left: 3px solid var(--red); }
    .stat-card.amber { border-left: 3px solid var(--amber); }
    .stat-label { font-size: 11px; font-weight: 500; color: var(--gray); text-transform: uppercase; letter-spacing: .6px; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--white); font-variant-numeric: tabular-nums; }
    .stat-value.red { color: var(--red-light); }
    .stat-value.amber { color: var(--amber); }
    .stat-sub { font-size: 11px; color: var(--gray); }

    /* ── FILTERS ── */
    .filters {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
      padding: 14px 20px; margin-bottom: 16px;
      display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
    }
    .filter-group { display: flex; align-items: center; gap: 6px; }
    .filter-label { font-size: 11px; color: var(--gray); font-weight: 500; white-space: nowrap; }
    input[type=text], select {
      background: var(--bg-row); border: 1px solid var(--border-dim); border-radius: 6px;
      color: var(--white); font-size: 13px; padding: 6px 10px; outline: none;
      transition: border-color .2s;
    }
    input[type=text]:focus, select:focus { border-color: var(--red); }
    input[type=text]::placeholder { color: var(--gray); }
    select option { background: #1a1a1a; }
    .search-input { width: 260px; }
    .btn {
      border: none; border-radius: 6px; padding: 6px 14px; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all .15s; display: flex; align-items: center; gap: 5px;
    }
    .btn-red { background: var(--red); color: #fff; }
    .btn-red:hover { background: var(--red-light); }
    .btn-ghost { background: transparent; color: var(--gray-light); border: 1px solid var(--border-dim); }
    .btn-ghost:hover { border-color: var(--gray); color: var(--white); }
    .filters-right { margin-left: auto; display: flex; gap: 8px; }

    /* ── TABLE WRAPPER ── */
    .table-wrapper {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
      overflow: hidden;
    }
    .table-header {
      padding: 14px 20px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .table-title { font-size: 13px; font-weight: 600; color: var(--white); display: flex; align-items: center; gap: 8px; }
    .table-count { font-size: 12px; color: var(--gray); background: var(--bg-row); border: 1px solid var(--border-dim); border-radius: 99px; padding: 2px 10px; }
    .table-scroll { overflow-x: auto; }

    table { width: 100%; border-collapse: collapse; }
    thead tr { background: var(--bg-row); }
    th {
      text-align: left; padding: 10px 14px; font-size: 11px; font-weight: 600;
      color: var(--gray); text-transform: uppercase; letter-spacing: .5px;
      border-bottom: 1px solid var(--border); white-space: nowrap;
    }
    tbody tr {
      border-bottom: 1px solid var(--border); cursor: pointer;
      transition: background .1s;
    }
    tbody tr:hover { background: var(--bg-hover); }
    tbody tr:last-child { border-bottom: none; }
    tbody tr.level-error { border-left: 3px solid var(--red); }
    tbody tr.level-warning { border-left: 3px solid var(--amber); }
    td { padding: 10px 14px; font-size: 13px; color: var(--gray-light); vertical-align: middle; }
    td.td-time { white-space: nowrap; font-size: 12px; font-family: var(--mono); color: var(--gray); }
    td.td-message { max-width: 380px; }
    .td-message-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--white); }
    td.td-endpoint { white-space: nowrap; font-size: 11px; font-family: var(--mono); color: var(--gray); }

    /* ── BADGES ── */
    .badge-level {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px;
      text-transform: uppercase; letter-spacing: .5px; white-space: nowrap;
    }
    .badge-level.error   { background: var(--red-dim);   color: var(--red-light); border: 1px solid rgba(220,38,38,.3); }
    .badge-level.warning { background: var(--amber-dim); color: var(--amber);     border: 1px solid rgba(245,158,11,.3); }
    .badge-event {
      display: inline-block; font-size: 11px; font-family: var(--mono);
      background: #161616; border: 1px solid var(--border-dim);
      color: var(--gray-light); padding: 2px 7px; border-radius: 4px; white-space: nowrap;
    }
    .badge-method {
      display: inline-block; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 3px;
      font-family: var(--mono); text-transform: uppercase;
    }
    .badge-method.get    { background: rgba(34,197,94,.12);  color: #4ade80; }
    .badge-method.post   { background: rgba(59,130,246,.12); color: #60a5fa; }
    .badge-method.patch  { background: rgba(234,179,8,.12);  color: #facc15; }
    .badge-method.delete { background: rgba(239,68,68,.12);  color: #f87171; }

    /* ── EMPTY / LOADING ── */
    .empty-state {
      padding: 60px 20px; text-align: center; color: var(--gray);
      display: flex; flex-direction: column; align-items: center; gap: 12px;
    }
    .empty-state i { font-size: 36px; color: var(--border-dim); }
    .empty-state p { font-size: 13px; }
    .loading-row td { text-align: center; padding: 40px; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border-dim); border-top-color: var(--red); border-radius: 50%; animation: spin .6s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pulse { animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

    /* ── PAGINATION ── */
    .pagination {
      padding: 12px 20px; border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .pagination-info { font-size: 12px; color: var(--gray); }
    .pagination-btns { display: flex; gap: 4px; }
    .pg-btn {
      width: 30px; height: 30px; border-radius: 6px; border: 1px solid var(--border-dim);
      background: transparent; color: var(--gray-light); font-size: 12px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all .15s;
    }
    .pg-btn:hover:not(:disabled) { border-color: var(--red); color: var(--red-light); }
    .pg-btn.active { background: var(--red); border-color: var(--red); color: #fff; font-weight: 700; }
    .pg-btn:disabled { opacity: .3; cursor: not-allowed; }

    /* ── MODAL ── */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.75); z-index: 200;
      display: flex; align-items: center; justify-content: center; padding: 20px;
      backdrop-filter: blur(4px);
      opacity: 0; pointer-events: none; transition: opacity .2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--bg-card); border: 1px solid var(--border-dim);
      border-radius: 12px; width: 100%; max-width: 860px; max-height: 90vh;
      overflow: hidden; display: flex; flex-direction: column;
      transform: translateY(12px); transition: transform .2s;
      box-shadow: 0 25px 80px rgba(0,0,0,.6);
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-head {
      padding: 18px 22px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 10px;
    }
    .modal-head .modal-level  { flex-shrink: 0; }
    .modal-head .modal-event  { font-size: 15px; font-weight: 600; color: var(--white); font-family: var(--mono); }
    .modal-head .modal-time   { margin-left: auto; font-size: 11px; color: var(--gray); font-family: var(--mono); flex-shrink: 0; }
    .modal-close {
      flex-shrink: 0; width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--border-dim);
      background: transparent; color: var(--gray); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all .15s; font-size: 13px;
    }
    .modal-close:hover { border-color: var(--red); color: var(--red-light); }
    .modal-body { overflow-y: auto; padding: 20px 22px; display: flex; flex-direction: column; gap: 16px; }

    .detail-section { display: flex; flex-direction: column; gap: 6px; }
    .detail-section-title {
      font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px;
      color: var(--gray); border-bottom: 1px solid var(--border); padding-bottom: 6px;
      display: flex; align-items: center; gap: 6px;
    }
    .detail-section-title i { color: var(--red); }
    .detail-message { font-size: 13px; color: var(--white); line-height: 1.6; }
    .detail-error {
      font-size: 13px; color: var(--red-light); line-height: 1.5; font-family: var(--mono);
      background: var(--red-dim); border: 1px solid rgba(220,38,38,.2); border-radius: 6px; padding: 10px 14px;
    }

    .meta-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .meta-item { background: var(--bg-row); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; }
    .meta-key { font-size: 10px; color: var(--gray); font-weight: 500; text-transform: uppercase; letter-spacing: .4px; margin-bottom: 3px; }
    .meta-val { font-size: 12px; color: var(--white); font-family: var(--mono); word-break: break-all; }
    .meta-val.none { color: var(--gray); font-style: italic; }

    pre.code-block {
      background: #0d0d0d; border: 1px solid var(--border); border-radius: 6px;
      padding: 12px 14px; font-family: var(--mono); font-size: 12px; line-height: 1.6;
      overflow-x: auto; white-space: pre-wrap; word-break: break-word;
      color: var(--gray-light); max-height: 280px; overflow-y: auto;
    }
    pre.code-block.stack { color: #f87171; }

    /* ── LIVE INDICATOR ── */
    .live-dot { width: 7px; height: 7px; background: var(--red); border-radius: 50%; animation: pulse 1s ease-in-out infinite; flex-shrink: 0; }
    .live-dot.off { background: var(--gray); animation: none; }

    /* ── RESPONSIVE ── */
    @media (max-width: 900px) {
      .stats { grid-template-columns: repeat(2, 1fr); }
      .meta-grid { grid-template-columns: repeat(2, 1fr); }
      .search-input { width: 180px; }
    }
    @media (max-width: 600px) {
      main { padding: 12px; }
      .stats { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<!-- ── HEADER ── -->
<header>
  <div class="logo">
    <i class="fas fa-fire-flame-curved"></i>
    <span>__FLARE_TITLE__</span>
  </div>
  <div class="header-right">
    <label class="refresh-toggle" title="Auto-refresh every 30s">
      <div class="live-dot off" id="liveDot"></div>
      <span id="refreshLabel">Auto-refresh</span>
      <label class="toggle-switch">
        <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh(this.checked)">
        <span class="toggle-slider"></span>
      </label>
    </label>
  </div>
</header>

<!-- ── MAIN ── -->
<main>

  <!-- STATS -->
  <div class="stats">
    <div class="stat-card red">
      <span class="stat-label">Errors (24h)</span>
      <span class="stat-value red" id="statErrors">—</span>
      <span class="stat-sub">last 24 hours</span>
    </div>
    <div class="stat-card amber">
      <span class="stat-label">Warnings (24h)</span>
      <span class="stat-value amber" id="statWarnings">—</span>
      <span class="stat-sub">last 24 hours</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Total stored</span>
      <span class="stat-value" id="statTotal">—</span>
      <span class="stat-sub">in stream</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Latest error</span>
      <span class="stat-value" id="statLastError" style="font-size:15px;padding-top:6px">—</span>
      <span class="stat-sub" id="statLastErrorSub"></span>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <div class="filter-group">
      <i class="fas fa-search" style="color:var(--gray);font-size:12px"></i>
      <input type="text" class="search-input" id="searchInput" placeholder="Search in message or error..." oninput="debounceLoad()" />
    </div>
    <div class="filter-group">
      <span class="filter-label">Level</span>
      <select id="levelFilter" onchange="loadLogs(1)">
        <option value="">All</option>
        <option value="ERROR">ERROR</option>
        <option value="WARNING">WARNING</option>
      </select>
    </div>
    <div class="filter-group">
      <span class="filter-label">Event</span>
      <input type="text" id="eventFilter" placeholder="e.g. http_exception" style="width:180px" oninput="debounceLoad()" />
    </div>
    <div class="filters-right">
      <div class="filter-group">
        <span class="filter-label">Per page</span>
        <select id="limitSelect" onchange="changeLimit()">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <button class="btn btn-ghost" onclick="clearFilters()"><i class="fas fa-xmark"></i> Clear</button>
      <button class="btn btn-red" onclick="loadLogs(1)"><i class="fas fa-rotate-right"></i> Refresh</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-wrapper">
    <div class="table-header">
      <span class="table-title">
        <i class="fas fa-list-ul" style="color:var(--red)"></i>
        Log entries
      </span>
      <span class="table-count" id="tableCount">—</span>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th style="width:155px">Timestamp</th>
            <th style="width:90px">Level</th>
            <th style="width:190px">Event</th>
            <th>Message</th>
            <th style="width:200px">Endpoint</th>
            <th style="width:70px">Status</th>
            <th style="width:30px"></th>
          </tr>
        </thead>
        <tbody id="logsTableBody">
          <tr class="loading-row"><td colspan="7"><span class="spinner"></span></td></tr>
        </tbody>
      </table>
    </div>
    <div class="pagination" id="paginationBar" style="display:none">
      <span class="pagination-info" id="paginationInfo"></span>
      <div class="pagination-btns" id="paginationBtns"></div>
      <span class="pagination-info" id="paginationRight" style="margin-left:auto"></span>
    </div>
  </div>

</main>

<!-- ── MODAL ── -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-head">
      <span class="modal-level" id="modalLevel"></span>
      <span class="modal-event" id="modalEvent"></span>
      <span class="modal-time"  id="modalTime"></span>
      <button class="modal-close" onclick="closeModalBtn()"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
  // ── Config injected at serve time ────────────────────────────────────────
  const API_BASE = "__FLARE_API_BASE__";

  // ── State ────────────────────────────────────────────────────────────────
  let currentPage      = 1;
  let totalPages       = 1;
  let currentLimit     = 25;
  let autoRefreshTimer = null;
  let debounceTimer    = null;

  // ── Boot ─────────────────────────────────────────────────────────────────
  loadLogs(1);
  loadStats();

  // ── STATS ────────────────────────────────────────────────────────────────
  async function loadStats() {
    try {
      const res  = await fetch(`${API_BASE}/stats`);
      const data = await res.json();
      document.getElementById('statErrors').textContent   = data.errors_last_24h ?? '—';
      document.getElementById('statWarnings').textContent = data.warnings_last_24h ?? '—';
      document.getElementById('statTotal').textContent    = (data.total_entries ?? 0).toLocaleString();

      if (data.newest_entry_ts) {
        const d = new Date(data.newest_entry_ts);
        document.getElementById('statLastError').textContent    = d.toLocaleTimeString();
        document.getElementById('statLastErrorSub').textContent = d.toLocaleDateString();
      }
    } catch (e) {
      // Stats are non-critical; fail silently
    }
  }

  // ── LOAD LOGS ────────────────────────────────────────────────────────────
  async function loadLogs(page = 1) {
    currentPage = page;
    showLoading();

    const params = new URLSearchParams({ page, limit: currentLimit });
    const level  = document.getElementById('levelFilter').value;
    const search = document.getElementById('searchInput').value;
    const event  = document.getElementById('eventFilter').value;
    if (level)  params.set('level',  level);
    if (search) params.set('search', search);
    if (event)  params.set('event',  event);

    try {
      const res  = await fetch(`${API_BASE}/logs?${params}`);
      const data = await res.json();
      renderTable(data);
    } catch (e) {
      showError();
    }
  }

  // ── RENDER TABLE ─────────────────────────────────────────────────────────
  function renderTable(data) {
    const tbody = document.getElementById('logsTableBody');
    totalPages  = data.pages;

    document.getElementById('tableCount').textContent = `${(data.total ?? 0).toLocaleString()} entries`;

    if (!data.logs || !data.logs.length) {
      tbody.innerHTML = `<tr><td colspan="7">
        <div class="empty-state">
          <i class="fas fa-circle-check"></i>
          <p>No log entries found with the current filters</p>
        </div></td></tr>`;
      document.getElementById('paginationBar').style.display = 'none';
      return;
    }

    tbody.innerHTML = data.logs.map(l => `
      <tr class="level-${(l.level||'').toLowerCase()}" data-id="${esc(l.id)}" data-log="${escJson(l)}" onclick="openModalFromRow(this)">
        <td class="td-time">${formatDate(l.timestamp)}</td>
        <td>${levelBadge(l.level)}</td>
        <td><span class="badge-event">${esc(l.event || '—')}</span></td>
        <td class="td-message"><div class="td-message-text" title="${esc(l.message||'')}">${esc(l.message || '—')}</div></td>
        <td class="td-endpoint">${esc(l.endpoint || '—')}</td>
        <td>${statusBadge(l.http_status)}</td>
        <td style="color:var(--gray);font-size:11px"><i class="fas fa-chevron-right"></i></td>
      </tr>
    `).join('');

    renderPagination(data);
  }

  // ── PAGINATION ───────────────────────────────────────────────────────────
  function renderPagination(data) {
    const bar   = document.getElementById('paginationBar');
    const info  = document.getElementById('paginationInfo');
    const btns  = document.getElementById('paginationBtns');
    const right = document.getElementById('paginationRight');

    if (!data.total) { bar.style.display = 'none'; return; }
    bar.style.display = 'flex';

    const from = ((data.page - 1) * data.limit) + 1;
    const to   = Math.min(data.page * data.limit, data.total);
    info.textContent  = `${from}–${to} of ${data.total.toLocaleString()}`;
    right.textContent = `Page ${data.page} of ${data.pages}`;

    // Only render page buttons when there is more than one page
    if (!data.pages || data.pages <= 1) { btns.innerHTML = ''; return; }

    const pages = [];
    pages.push({ label: '<i class="fas fa-chevron-left"></i>', page: data.page - 1, disabled: data.page <= 1 });

    let start = Math.max(1, data.page - 2);
    let end   = Math.min(data.pages, start + 4);
    start = Math.max(1, end - 4);

    if (start > 1) pages.push({ label: '1', page: 1 });
    if (start > 2) pages.push({ label: '…', page: null });
    for (let i = start; i <= end; i++) pages.push({ label: i, page: i, active: i === data.page });
    if (end < data.pages - 1) pages.push({ label: '…', page: null });
    if (end < data.pages)     pages.push({ label: data.pages, page: data.pages });
    pages.push({ label: '<i class="fas fa-chevron-right"></i>', page: data.page + 1, disabled: data.page >= data.pages });

    btns.innerHTML = pages.map(p =>
      `<button class="pg-btn ${p.active ? 'active' : ''}" ${p.disabled || !p.page ? 'disabled' : ''} onclick="${p.page ? `loadLogs(${p.page})` : ''}">${p.label}</button>`
    ).join('');
  }

  // ── MODAL ────────────────────────────────────────────────────────────────
  function openModalFromRow(row) {
    let log;
    try { log = JSON.parse(row.getAttribute('data-log')); } catch (e) { return; }
    openModal(log);
  }

  function openModal(log) {
    document.getElementById('modalLevel').innerHTML  = levelBadge(log.level);
    document.getElementById('modalEvent').textContent = log.event || '—';
    document.getElementById('modalTime').textContent  = formatDate(log.timestamp);

    const body = document.getElementById('modalBody');
    body.innerHTML = `
      ${log.message ? `
      <div class="detail-section">
        <div class="detail-section-title"><i class="fas fa-message"></i> Message</div>
        <div class="detail-message">${esc(log.message)}</div>
      </div>` : ''}

      ${log.error ? `
      <div class="detail-section">
        <div class="detail-section-title"><i class="fas fa-circle-exclamation"></i> Error</div>
        <div class="detail-error">${esc(log.error)}</div>
      </div>` : ''}

      ${log.stack_trace ? `
      <div class="detail-section">
        <div class="detail-section-title"><i class="fas fa-layer-group"></i> Stack Trace</div>
        <pre class="code-block stack">${esc(log.stack_trace)}</pre>
      </div>` : ''}

      <div class="detail-section">
        <div class="detail-section-title"><i class="fas fa-info-circle"></i> Request Info</div>
        <div class="meta-grid">
          ${metaItem('Request ID',  log.request_id)}
          ${metaItem('Endpoint',    log.endpoint)}
          ${metaItem('Method',      log.http_method)}
          ${metaItem('HTTP Status', log.http_status)}
          ${metaItem('IP Address',  log.ip_address)}
          ${metaItem('Duration',    log.duration_ms != null ? log.duration_ms + ' ms' : null)}
        </div>
      </div>

      ${log.context ? `
      <div class="detail-section">
        <div class="detail-section-title"><i class="fas fa-brackets-curly"></i> Context</div>
        <pre class="code-block">${esc(JSON.stringify(log.context, null, 2))}</pre>
      </div>` : ''}
    `;

    document.getElementById('modalOverlay').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal(e) {
    if (e.target === document.getElementById('modalOverlay')) closeModalBtn();
  }
  function closeModalBtn() {
    document.getElementById('modalOverlay').classList.remove('open');
    document.body.style.overflow = '';
  }

  // ── AUTO REFRESH ─────────────────────────────────────────────────────────
  function toggleAutoRefresh(on) {
    const dot   = document.getElementById('liveDot');
    const label = document.getElementById('refreshLabel');
    clearInterval(autoRefreshTimer);
    if (on) {
      dot.classList.remove('off');
      label.textContent = 'Live';
      autoRefreshTimer = setInterval(() => { loadLogs(currentPage); loadStats(); }, 30000);
    } else {
      dot.classList.add('off');
      label.textContent = 'Auto-refresh';
    }
  }

  // ── HELPERS ──────────────────────────────────────────────────────────────
  function debounceLoad() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => loadLogs(1), 400);
  }

  function changeLimit() {
    currentLimit = parseInt(document.getElementById('limitSelect').value, 10);
    loadLogs(1);
  }

  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('levelFilter').value = '';
    document.getElementById('eventFilter').value = '';
    loadLogs(1);
  }

  function showLoading() {
    document.getElementById('logsTableBody').innerHTML =
      `<tr class="loading-row"><td colspan="7"><span class="spinner"></span></td></tr>`;
  }

  function showError() {
    document.getElementById('logsTableBody').innerHTML =
      `<tr><td colspan="7"><div class="empty-state">
        <i class="fas fa-triangle-exclamation" style="color:var(--red)"></i>
        <p>Failed to load logs. Check your connection.</p>
      </div></td></tr>`;
  }

  function levelBadge(level) {
    if (!level) return '';
    const l    = level.toLowerCase();
    const icon = l === 'error' ? 'fa-circle-xmark' : 'fa-triangle-exclamation';
    return `<span class="badge-level ${l}"><i class="fas ${icon}"></i>${level}</span>`;
  }

  function statusBadge(status) {
    if (!status) return '<span style="color:var(--gray)">—</span>';
    const color = status >= 500 ? 'var(--red-light)' : 'var(--amber)';
    return `<span style="color:${color}; font-family:var(--mono); font-size:12px">${status}</span>`;
  }

  function metaItem(key, val) {
    return `<div class="meta-item">
      <div class="meta-key">${esc(key)}</div>
      <div class="meta-val ${!val ? 'none' : ''}">${val ? esc(String(val)) : 'N/A'}</div>
    </div>`;
  }

  function formatDate(iso) {
    if (!iso) return '—';
    const d = new Date(iso);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
  }

  function esc(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function escJson(obj) {
    return JSON.stringify(obj).replace(/'/g,"&#39;").replace(/"/g,'&quot;');
  }

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModalBtn(); });
</script>
</body>
</html>
